{% extends "base.html" %}
{% load i18n %}
{% load opencommunity %}

{% block extra-page-id %}
	id="upcoming-meeting"
{% endblock %}

{% block page_header %}
    {% trans "Upcoming Meeting" %}
{% endblock %}

{% block header-start %}
    {% if cperms.community.editupcoming_community %}
        <a href="#upcoming-panel" data-icon="edit" data-iconpos="notext" data-rel="panel"></a>
    {% endif %}
{% endblock %}

{% block header-end %}
    <a href="#issuespanel" data-icon="bars" data-iconpos="notext"  data-rel="popup"></a>
{% endblock %}

{% block startpanel %}
    <div data-role="panel" id="upcoming-panel">
        <ul data-role="listview">

            {% if cperms.issues.add_issue %}
                <li data-icon="plus">
                    <a data-rel="form" href="{% url "issue_create" community.id %}"  data-icon="plus" data-iconpos="notext">{% trans "Create Issue" %}</a>
                </li>
            {% endif %}

            {% if cperms.community.editupcoming_community %}
                <li data-icon="edit">
                    <a data-rel="form"
                        href="{% url "upcoming_edit" community.id  %}">
                        {% trans "Edit" %}
                    </a>
                </li>
            {% endif %}

            {% if cperms.community.editparticipants_community %}
                <li data-icon="edit">
                    <a data-rel="form"
                        href="{% url "upcoming_edit_participants" community.id  %}">
                        {% trans "Select Participants" %}
                    </a>
                </li>
            {% endif %}

            {% if cperms.community.editagenda_community %}
                <li>
                    <a data-rel="form" 
                    href="{% url "upcoming_publish" community.id  %}">
                        {% if object.upcoming_meeting_started %}
                          {% trans "Send" %}
                        {% else %}
                          {% trans "Publish" %}
                        {% endif %}
                    </a>
                </li>
            {% endif %}
            
            {% if cperms.community.editupcoming_community %}
                <li>
                    <a data-rel="form" 
                    href="{% url "upcoming_start" community.id  %}">
                        {% trans "Start Meeting" %}
                    </a>
                </li>
            {% endif %}

        </ul>
    </div>

{% endblock %}

{% block endpanel %}
    {% include "_main_panel.html" %}
{% endblock %}

{% block content %}
    <div class="ui-grid-solo">
        <div class="ui-block-a">
            {% if object.upcoming_meeting_started %}
                <div class="ui-bar ui-bar-e ctr">
                    <b>{% trans "Meeting started" %}</b>
                </div>
            {% endif %}
            {% if object.upcoming_meeting_is_published %}
                <div class="ui-bar ui-bar-e ctr">
                    {% trans "Published at" %} {{object.upcoming_meeting_published_at}}
                    ({% trans "Version" %} {{object.upcoming_meeting_version}})
                </div>
            {% else %}
                <div class="ui-bar ui-bar-e">
                    {% trans "Draft" %}
                </div>
            {% endif %}
        </div>
    </div>


    <div data-role="collapsible" data-collapsed="{% if object.upcoming_meeting_started and cperms.community.editagenda_community %}true{% else %}false{% endif %}"
        data-theme="c" data-content-theme="d" data-mini="true">
        <h4>{% trans "Meeting Details" %}</h4>

        <p>
                <b>{% trans "Scheduled at" %}:</b>
                {{object.upcoming_meeting_scheduled_at|default:_("Not set yet")}}
                <br/>
                <b>{% trans "Location" %}:</b>
                {{object.upcoming_meeting_location|default:_("Not set yet")}}
                {% if object.upcoming_meeting_comments %}
                    <p>
                        {{object.upcoming_meeting_comments|safe}}
                    </p>
                {% endif %}
        </p>

    </div>

    <div id="agenda-container" data-role="collapsible" data-collapsed="false"
            data-theme="b" data-content-theme="c" >

        <h4>
            {% trans "Agenda items" %}
            <span class="loader">
                <img src="{{STATIC_URL}}images/ajax-loader.gif" alt="Loading"/>
            </span>
        </h4>
        <ul id="agenda" data-role="listview" data-split-icon="minus" data-count-theme="a">
                {% for i in object.upcoming_issues %}

                <li class="issue" data-issue="{{i.id}}">
                    <div class="timer" data-url="{% url 'issue_set_length' community.id i.id %}">
                        <span data-strict="{{i.length_in_minutes|minutes_strict}}">{{i.length_in_minutes|minutes|default:'?'}}</span>
                    </div>
                    <div class="grab"></div>
                    <a href="{{i.get_absolute_url}}">
                        {{i.title}}
                        {% if object.upcoming_meeting_started and i.accepted_proposals.count == 0 %}
                            <span class="ui-li-count">
                                {% trans "Undecided" %}
                            </span>
                        {% endif %}
                    </a>
                    {% if cperms.community.editagenda_community %}
                        <a href="#" class="addremove"></a>
                    {% endif %}
                </li>

                {% endfor %}
        </ul>
    </div>

    {% if object.upcoming_meeting_started and cperms.community.editupcoming_community %}

        <h3>{% trans "Summary" %}</h3>
        <div class="ui-grid-solo">
            <div class="ui-block-a">
                <div class="ui-bar ui-bar-c">
                    <p>
                        <div class="push">
                            <a data-rel="form" data-role="button" data-theme="a" 
                            data-inline="true"
                            href="{% url "upcoming_edit_summary" community.id %}" class="btn">
                                {% trans "Edit" %}
                            </a>
                        </div>
                        {% if object.upcoming_meeting_summary %}
                          {{object.upcoming_meeting_summary|safe}}
                        {% endif %}
                    </p>
                </div>
            </div>
        </div>

    {% endif %}

    {% if object.upcoming_meeting_started and cperms.meetings.add_meeting %}
        <a data-rel="form" data-role="button" data-theme="a"
        href="{% url "upcoming_close" community.id %}" class="btn">
            {% trans "Close Meeting" %}
        </a>
    {% endif %}

    {% if cperms.community.editagenda_community %}

        <div data-role="collapsible" data-collapsed="{% if object.upcoming_meeting_started %}true{% else %}false{% endif %}"
                data-theme="b" data-content-theme="c" >
    
            <h4>{% trans "Available Issues" %}</h4>
    
            <ul id="available" data-role="listview" data-split-icon="plus">
    
                {% for i in object.available_issues %}
    
                    <li class="issue" data-issue="{{i.id}}" data-set="{{i.in_upcoming_meeting|yesno:'1,0'}}">
                        <div class="grab"></div>
                        <a href="{{i.get_absolute_url}}">
                            {{i.title}}
                            {% with proposals=i.accepted_proposals.count %}
                                {% if proposals %}
                                    <span class="ui-li-count">
                                        {{ proposals }}
                                    </span>
                                {% endif %}
                            {% endwith %}
                        </a>
                        <a href="#" class="addremove"></a>
                    </li>
    
                {% endfor %}
            </ul>
    
        </div>
        
    {% endif %}


{% endblock %}

{% block extrahead %}
    {# <link href="{{ STATIC_URL }}jquery-ui/css/ui-lightness/jquery-ui-1.10.2.custom.css" rel="stylesheet"> #}
{% endblock %}

{% block scripts %}
    <script src="{{STATIC_URL}}jquery-ui/js/jquery-ui-1.10.2.custom.js"></script>
    <script src="{{STATIC_URL}}js/jquery.ui.touch-punch.js"></script>
    <script src="{{STATIC_URL}}js/upcoming.js"></script>
    <script src="{{STATIC_URL}}js/issues.js"></script>
{% endblock %}
