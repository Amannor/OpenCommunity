{% extends "base.html" %}
{% load i18n %}
{% load opencommunity %}

{% block extra-page-id %}
id="issue-list"
{% endblock %}

{% block page_header %}
{% trans "Issues" %}
{% endblock %}

{% block pagemenu %}
{% if user.id and cperms.issues.add_issue %}
<div class="one_action_icon">
	<a href="{% url "issue_create" community.id %}" class="btn btn-oc" data-rel="form"> <i class="fa fa-plus"></i> {% trans "Add" %} </a>
</div>
{% endif %}
{% endblock %}

{% block content %}
    {% if community.issue_ranking_enabled %}
    <ul id="issues-order" class="nav nav-tabs">
        <span style="float:right;margin-left: 2px;line-height: 1.428571429;border: 1px solid transparent;padding:10px 15px;font-weight:bold;">{% trans "Sort" %}</span>
        <li class="active"><a href="#by_time" data-toggle="tab">{% trans "By time" %}</a></li>
        {% if cperms.issues.vote_ranking %}
            <li><a href="#my_vote" data-toggle="tab">{% trans "My vote" %}</a></li>
        {% endif %}
        <li><a href="#by_rank" data-toggle="tab">{% trans "By rank" %}</a></li>
    </ul>
    <div class="tab-content">
        <div id="by_time" class="tab-pane active"> 
            <div class="row">
                <!-- <h2 class="col-xs-3 col-sm-1">{% trans "Search" %}:</h2> -->
                <div class="col-xs-12 form-group">
                    <input type="text" class="form-control issue-search" placeholder="{% trans "Search in agenda list" %}">
                </div>
            </div>
            <table class="table table-condensed issue-table">
            {% for object in object_list %}
                <tr class="issue-list">
                    <td class="issue_date">{{ object.created_at|ocshortdate }}</td>
                    <td class="issue_title left_arrow"><a href="{{ object.get_absolute_url }}"> {{ object.title }}</a></td>
                </tr>
            {% endfor %}
            </table>
        </div>

        {% if cperms.issues.vote_ranking %}
        <div id="my_vote" class="tab-pane"> 
            {% with can_sort=True %}
            <h2> {% trans "Issues for discussion" %} </h2>

            <ul id="ordered" class="nav nav-pills nav-stacked">
                {% for i in my_vote %}
                    {% include "issues/_issue_sort.html" %}
                {% endfor %}
            </ul>
            
            <div class="narrow">
              <a id="do_ranking_vote" href="{% url 'issues' community.id %}" data-rel="formo" class="btn btn-warning btn-block btn-lg ">{% trans 'Submit' %}</a>
            </div>
            
            <h2>{% trans "Other issues" %}</h2>
        
            <ul id="voted_out" class="nav nav-pills nav-stacked">
                {% for i in my_non_ranked %}
                    {% include "issues/_issue_sort.html" %}
                {% endfor %}
            </ul>
            {% endwith %}
        </div>  
        {% endif %}

        <div id="by_rank" class="tab-pane"> 
            <h2> {% trans "Issues for discussion" %} </h2>
            {% with can_sort=False %}

            <table id="voted_order" class="table table-condensed issue-table">
                {% for object in sorted_issues %}
                    <tr class="issue-list">
                        <td class="issue_date">{{ forloop.counter }}</td>
                        <td class="issue_title left_arrow"><a href="{{ object.get_absolute_url }}"> {{ object.title }}</a></td>
                    </tr>
                {% endfor %}
            </table>

            {% endwith %}
        </div>    
    </div>
    {% else %}
        <div id="by_time"> 
            <table class="table table-condensed issue-table">
                {% for object in object_list %}
                    <tr class="issue-list">
                        <td class="issue_date">{{ object.created_at|ocshortdate }}</td>
                        <td class="issue_title left_arrow"><a href="{{ object.get_absolute_url }}"> {{ object.title }}</a></td>
                    </tr>
                {% endfor %}
            </table>
        </div>

    {% endif %}
{% endblock %}

{% block dialogs %}
{% endblock %}

{% block extrahead %}
    <link rel="stylesheet" href="{{STATIC_URL}}bootstrap/css/typeahead.js-bootstrap.css"/>
{% endblock %}

{% block scripts %}
<script src="{{STATIC_URL}}bootstrap/js/typeahead.min.js"></script>
<script src="{{STATIC_URL}}js/hogan-2.0.0.js"></script>
<script src="{{STATIC_URL}}js/issues.js"></script>
<script src="{{STATIC_URL}}jquery-ui/js/jquery-ui-1.10.2.custom.js"></script>
<script>
    function disable_send_button() {
        $('#do_ranking_vote').addClass('disabled');
        $('#do_ranking_vote').text('{% trans "Preferences sent" %}');
    }

    function enable_send_button() {
        $('#do_ranking_vote').show();
        if($('#do_ranking_vote').hasClass('disabled')) {
            $('#do_ranking_vote').removeClass('disabled');
            $('#do_ranking_vote').text('{% trans "Submit" %}');
        }
    }

    $(function() {
        $('#do_ranking_vote').hide();
        $('input.issue-search').bind('input', function() {
            searchIssues($(this).val().trim());
        });
        
        $('#ordered').sortable({
            //containment: $('#ordered').parent().parent(),
            opacity: 0.6,
            //cursorAt: { top: 25 },
            handle: ".grab",
            update: function(event, ui) {
                enable_send_button();
            }
        }).removeClass('ui-corner-all').filter('li').removeClass('ui-corner-bottom');
        $('#ordered').on('click', '.addremove', function() {
            var el = $(this).parent().parent();
            el.addClass('loading');
            $("#voted_out").append(el);
            // activate send button
            enable_send_button();
        });
        $('#voted_out').on('click', '.addremove', function() {
            var el = $(this).parent().parent();
            el.addClass('loading');
            $("#ordered").append(el);
            // activate send button
            enable_send_button(); 
        });

        $('body').on('click', '#do_ranking_vote', function(event) {
            event.preventDefault();
            var url = $(this).attr('href');
            var order_list = [];
            $.each($('#ordered li'), function(idx, el) {
                order_list.push($(el).data('issue'));
            })
            $.post(url, {
                            new_order: JSON.stringify(order_list),
                            community_id: '{{ community.id }}',
                    }, 
                    function(p){ 
                        disable_send_button();
                    });
        });
	});
</script>
{% endblock %}
