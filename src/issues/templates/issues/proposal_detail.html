{% extends "base.html" %}
{% load i18n %}
{% load humanize %}

{% block extra-page-id %}
    id="proposal-detail"
{% endblock %}

{% block page_header %}
    {% trans "Proposal" %}
{% endblock %}

{% block header-start %}
    <a href="#proposalpanel" data-icon="bars" data-iconpos="notext" data-rel="panel"></a>
{% endblock %}

{% block startpanel %}
    <div data-role="panel" id="proposalpanel">
        <ul data-role="listview">
            {% if cperms.issues.editclosed_proposal or object.is_open %}
                {% if cperms.issues.editopen_proposal or object.created_by == user %}
                    <li><a data-rel="form" href="{{object.get_edit_url}}">{% trans "Edit" %}</a></li>
                    <li><a data-rel="form" href="{{object.get_delete_url}}">{% trans "Delete" %}</a></li>
                {% endif %}
            {% endif %}
            {% if object.is_task and cperms.issues.edittask_proposal %}
                {% if cperms.issues.editclosed_proposal or object.is_open %}
                    <li><a data-rel="form" href="{{object.get_edit_task_url}}">{% trans "Reassign task" %}</a></li>
                {% endif %}
            {% endif %}
        </ul>
    </div>
{% endblock %}

{% block content %}


    <div class="proposal" data-id="{{object.id}}"
         data-accepted="{{object.status}}">

        <a class="prop-issue-title" href="{{object.issue.get_absolute_url}}">
            <div class="prop-issue">{{object.issue}}</div>
        </a>

        <div class="ui-grid-solo prop-subject">
            <div class="prop-type">
                <img src="{{STATIC_URL}}m/images/{% if object.type == 1 %}task-icon{% endif %}{% if object.type == 2 %}rule-icon{% endif %}{% if object.type == 3 %}general-icon{% endif %}.png"/>
            </div>
            <div class="prop-info">
                <h4 class="abstract abstract-title">{{object.title}}</h4>
                <h4 class="abstract assigned_to">
                {% if object.type == 1 %}
                    {% if object.assigned_to %} 
                        <p style="margin: 0; line-height: 14px;"><b>{% trans "Assigned to" %}:</b> {{ object.assigned_to }}</p>
                        {% if object.assigned_to and object.due_by %}{% endif %}
                    {% endif %}
                    {% if object.due_by %}
                        <p style="margin: 0; line-height: 14px;"><b>{% trans "Due by" %}:</b> {{ object.due_by }}</p>
                    {% endif %}
                {% endif %}
                <p>
                    <b>{% trans "By:" %}</b> {{ object.created_by}}. {{ object.created_at}} {# ({{ object.created_at|naturaltime}}) #} <br/>
                </p>
                </h4>

            </div>
        </div>

        <br />


       {% if cperms.issues.view_proposal_in_discussion or not proposal.is_open %}
            {% if object.status == object.statuses.ACCEPTED or object.status == object.statuses.REJECTED %}
                    <div class="{{object.get_status_class}}">
                    	  {% if object.status == object.statuses.ACCEPTED %}
	                        {% trans "Proposal accepted" %}!
                        {% endif %}

                        {% if object.status == object.statuses.REJECTED %}
	                        {% trans "Proposal rejected" %}!
                        {% endif %}
                        
    	                {% if object.decided_at_meeting %} (<a href="{{ object.decided_at_meeting.get_absolute_url }}">
                            {{ object.decided_at_meeting.get_title_or_date }}
                            </a>)
                        {% endif %}

                        {% if object.can_vote and cperms.issues.acceptopen_proposal %}
			                <a href="#" data-role="button" class="unaccept" data-value="{{object.statuses.IN_DISCUSSION}}" data-theme="a">{% trans "Cancel approval" %}</a>
                        {% endif %}
                    </div>
            {% endif %}
        {% endif %}
        
        {% if object.abstract %}
            <div data-role="collapsible" data-collapsed="false"
                data-theme="c" data-content-theme="d" data-mini="true">
                <h4>{% trans "Abstract" %}</h4>
                <p>{{object.abstract|safe}}</p>
            </div>
        {% endif %}

        {% if object.content %}
            <div class="proposal-info">
                {# <h4>{% trans "Content" %}</h4> #}
                {{object.content|safe}}
            </div>
        {% endif %}

        {% if object.can_vote and cperms.issues.acceptopen_proposal %}
            <div class="narrow accept-buttons">
                {% if object.status != object.statuses.ACCEPTED %}
                    <button data-role="button" class="proposal-action" name="accepted" value="{{object.statuses.ACCEPTED}}" data-theme="a">{% trans "Accept proposal" %}</button>
                {% endif %}
                {% if object.status != object.statuses.REJECTED %}
                    <button data-role="button" class="proposal-action" name="accepted" value="{{object.statuses.REJECTED}}" data-theme="a">{% trans "Reject proposal" %}</button>
                {% endif %}
            </div>                  
        {% endif %}

    </div>
{% endblock %}


{% block extrahead %}
    <link rel="stylesheet" href="{{STATIC_URL}}css/proposal.css"/>
{% endblock %}

{% block scripts %}

    <script src="{{STATIC_URL}}js/proposal.js"></script>

{% endblock %}
