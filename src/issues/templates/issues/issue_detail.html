{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% load voting_tags community_tags opencommunity %}

{% block extra-page-id %}
id="issue-detail"
{% endblock %}

{% block page_header %}
<!-- {% trans "Issue" %} -->
{% endblock %}

{% comment %}
{% block pagemenu %}
    {% if cperms.issues.editclosed_issue or not object.is_archived %}
        {% if cperms.issues.editopen_issue or object.created_by == user %}
            <a data-rel="form" data-replace=".issue-top" class="btn btn-oc" href="{{object.get_edit_url}}" title='{% trans "Edit" %}'>
                 <i class="fa fa-edit"></i> <span>{% trans "Edit" %}</span>
            </a>
            {% if cperms.issues.editopen_issue %}
                <a id="add-attachment" data-rel="form" class="btn btn-oc" href="{% url 'add_attachment' community.id object.id %}" title='{% trans "Add attachment" %}'>
                    <i class="fa fa-paperclip"></i> <span>{% trans 'Add attachment' %}</span>
                </a>
            {% endif %}
            <a class="btn btn-oc" data-rel="form" href="{{object.get_delete_url}}" title='{% trans "Delete" %}'>
                <i class="fa fa-trash-o"></i> <span>{% trans "Delete" %}</span>
            </a>
        {% endif %}
    {% endif %}
{% endblock %}
{% endcomment %}

{% block content %}
<div class="meeting_header">
	<a class="three_dot_sentence level1" href="{{object.community.get_upcoming_absolute_url}}">{% trans "Agenda" %} - {{object.community.upcoming_meeting_title}}</a>
</div>

<div class="issue_main">
<div class="issue_right_column col-sm-3 hidden-xs">
	<ul class="issues_list">
		{% for i in object.community.upcoming_issues %}
		<li><a href="{{ i.get_absolute_url }}">{{ i }}</a></li>
		{% endfor %}
	</ul>
</div>

<div class="issue_left_column col-sm-9 col-xs-12">
<div class="issue_left_column_inner">



{% if object.is_archived %}

<h2 class="text-center"> --{% trans "Closed" %}-- </h2>

{% else %}

{% if object.is_upcoming %}
    {% if community.upcoming_meeting_is_published or cperms.communities.viewupcoming_draft %}
        <h2 class="text-center"> --{% trans "In agenda" %}-- </h2>
    {% endif %}
{% endif %}

{% endif %}
{% if object.can_straw_vote and not user.id %}
<div class="text-center" style="margin-bottom: 10px;">
    <a href="{% url 'login' %}?next={{ request.path }}" class="btn btn-warning">{% trans "Login to vote" %}</a>
</div>
{% endif %}

    <div class="issue-top">
        {% include "issues/_issue_title.html" %}
    </div>


    {% with can_straw_vote=object.can_straw_vote %}

        {% csrf_token %}
		<div class="historical_tabs">
        <ul class="nav nav-tabs">
        	<li><a href="#agendaitem-current" data-toggle="tab">{{object.community.upcoming_meeting_title}}</a></li>
        {% for ai in object.agenda_items.all %}
		  <li><a href="#agendaitem-{{ai.id}}" data-toggle="tab">{{ai.meeting}}</a></li>
		{% endfor %}
		</ul>

		<div class="tab-content">
        {% for ai in object.agenda_items.all %}
            <div class="tab-pane" id="agendaitem-{{ai.id}}">

                <h2>{{ai.meeting}}
                    {% if ai.proposals.count %}
                          <b>({{ ai.proposals.count }} {% trans "Decisions" %})</b>
                    {% endif %}
                </h2>

                <div class="agendaitem-details">

                    {% if ai.background or ai.proposals.count or ai.comments.count %}

                        {% if ai.background %}
                            <div class="oc_detail_top">
                                {{ai.background|userhtml}}
                            </div>
                        {% endif %}

                        {% if ai.proposals.count %}
                            <div class="past_proposals">
                                {% for proposal in ai.proposals %}
                                    {% include 'issues/_proposal.html' %}
                                {% endfor %}
                            </div>
                        {% endif %}

                        {% if ai.comments.count %}
                          <ul class="comments">
                              <div class="historic_comments past_proposals">
                                  {% for c in ai.comments %}
                                      {% include "issues/_comment.html" %}
                                  {% endfor %}
                              </div>
                          </ul>
                        {% endif %}

                    {% else %}
                        {% trans "No decision or summary" %}
                    {% endif %}


                </div>
            </div>
        {% endfor %}
       </div>
		</div>
		
        <div class="issue_proposal">

            <div id="issue-abstract">
                {% include 'issues/_issue-abstract.html' %}
            </div>

            {% if cperms.issues.editclosed_issue or not object.is_archived %}
                {% if cperms.issues.editopen_issue or object.created_by == user %}
                    <a data-rel="form" data-replace="#issue-abstract" class="btn btn-oc"
                    href="{% url 'issue_edit_abstract' object.community.id object.id %}" title='{% trans "Edit Abstract" %}'>
                         <i class="fa fa-edit"></i> <span>{% trans "Edit Abstract" %}</span>
                    </a>
                {% endif %}
            {% endif %}

            <div class="open-proposals">
                <h2>
                    {% trans "Proposals" %}
                </h2>

                {% for proposal in object.proposals.open %}

                    {% include 'issues/_proposal.html' %}

                    {% if can_straw_vote and not proposal.decided and cperms.issues.vote and user|member_of:community %}
                        <div class="issue_proposal_vote">
                            {% include 'issues/_vote.html' %}
                        </div>
                    {% endif %}

                {% endfor %}
            </div>
        </div>

    {% endwith %}

{% if cperms.issues.add_proposal and not object.is_archived %}
<div class="narrow clear">
    <a class="btn btn-oc btn-lg btn-block" data-rel="form" data-append-to=".open-proposals" href="{% url "proposal_create" community.id object.id %}">{% trans "Add Proposal" %}</a>
</div>
{% endif %}

{% if object.active_comments.count or cperms.issues.add_issuecomment and object.community.upcoming_meeting_started and object.is_upcoming %}
<div class="issuecomments">
    <ul id="comments" class="comments">
        <h2>{% trans "Summary" %}</h2>
        {% for c in object.new_comments %}
            {% include "issues/_comment.html" %}
        {% endfor %}
        {% if cperms.issues.add_issuecomment and object.community.upcoming_meeting_started and object.is_upcoming %}
        <li class="rich_editor">
            <form id="add-comment" method="post">
                {% csrf_token %}
                {{form}}
                <div class="narrow">
                    <button class="add-comment-btn btn btn-oc btn-lg btn-block" disabled="1">{% trans "Save" %}</button>
                </div>
            </form>
        </li>
        {% endif %}
    </ul>
</div>
{% endif %}

    
{% if cperms.meetings.add_meeting %}
    {% if object.status == object.statuses.IN_UPCOMING_MEETING and object.community.upcoming_meeting_started or object.completed %}
    <br/>
        <form id="issue-complete" method="post" action="{% url 'issue_complete' community.id issue.id %}">
            {% csrf_token %}
            <input name="enable" type="hidden" value="{{object.completed|yesno:'0,1'}}"/>
            <div class="narrow">
                <button class="close-issue-btn btn btn-oc btn-block btn-lg">
                        {% if object.completed %}{% trans "Undo complete discussion" %}{% else %}{% trans "Complete discussion" %}{% endif %}
                </button>
            </div>
        </form>
    <br/>
    {% endif %}
{% endif %}
</div>
</div>
</div>

{% endblock %}

{% block extrahead %}
<link rel="stylesheet" href="{{STATIC_URL}}css/issue.css"/>
<link rel="stylesheet" href="{{STATIC_URL}}bootstrap/css/typeahead.js-bootstrap.css"/>
{% endblock %}

{% block scripts %}
<script src="{{STATIC_URL}}js/issue.js"></script>
<script src="{{STATIC_URL}}js/Chart.js"></script>
<script src="{{STATIC_URL}}js/proposal.js"></script>
<script src="{{STATIC_URL}}js/_piechart.js"></script>
<script src="{{STATIC_URL}}bootstrap/js/typeahead.min.js"></script>
<script src="{{ STATIC_URL }}/js/hogan-2.0.0.js"></script>
<script src="{{STATIC_URL}}js/issues.js"></script>
<script src="{% url 'jsi18n' %}"></script>

<script>
    $(function() {
        {% for proposal in object.proposals.open %}
        {% if proposal.can_show_straw_votes %}
            createChart(
                {{ proposal.votes_pro|default_if_none:0 }},
                {{ proposal.votes_con|default_if_none:0 }},
                {{ proposal.community_members|subtract:proposal.votes_con|default_if_none:0|subtract:proposal.votes_pro|default_if_none:0 }},
                {{ proposal.id }}
                );
        {% endif %}
        {% endfor %}
    });
</script>

{% endblock %}
