{% extends "base.html" %}
{% load i18n %}
{% load humanize %}
{% load voting_tags community_tags opencommunity %}

{% block extra-page-id %}
id="issue-detail"
{% endblock %}

{% block page_header %}
<!-- {% trans "Issue" %} -->
{% endblock %}

{% block content %}
<div class="meeting_header">
    {% if meeting %}
        <a class="three_dot_sentence level1" href="{{meeting.get_absolute_url}}">{{ meeting.get_title_or_shortdate }}</a>
    {% else %}
        <a class="three_dot_sentence level1" href="{{object.community.get_upcoming_absolute_url}}">{{object.community.upcoming_meeting_title|default:_("Upcoming Meeting")}}</a>
    {% endif %}
</div>

<div class="issue_main clearfix">
    <div class="issue_right_column col-sm-3 hidden-xs">
        <ul class="issues_list">
            {% if meeting %}
                {% for ai in meeting.agenda.all %}
                <li{% if object == ai.issue %} class="active_issue"{% endif %}>
                    <a href="{{ ai.issue.get_absolute_url }}?m_id={{meeting.id}}">{{ ai.issue }}</a>
                </li>
                {% endfor %}
            {% else %}
                {% for i in object.community.upcoming_issues|dictsort:"order_in_upcoming_meeting" %}
                <li{% if object == i %} class="active_issue"{% endif %}>
                    <a href="{{ i.get_absolute_url }}">{{ i }}</a>
                </li>
                {% endfor %}
            {% endif %}
        </ul>
    </div>

    <div class="issue_left_column col-sm-9 col-xs-12" style="margin-bottom: -40px;">
        <div class="issue_left_column_inner">

            {% with can_straw_vote=object.can_straw_vote %}

            {% csrf_token %}
                {% if object.agenda_items.count %}
            <ul
                data-filter=".filter"
                class="nav nav-tabs"
                style="
                    float: left;
                    margin-top: -31px;
                    margin-left:-23px;
                    border-bottom: 0; 
                    padding-top: 37px;"
                >

                {% if not object.is_archived %}
                    <li{% if not meeting %} class="active"{% endif %}>
                        <a href="#" data-toggle="filter" data-show=".filter-upcoming">{% trans "Next" %}</a>
                    </li>
                {% endif %}


                  <li class="dropdown{% if meeting %} active{% endif %}">
                    <a role="button" data-toggle="dropdown" href="#">
                        {% trans "Meetings" %}
                      <b class="caret"></b>
                    </a>
                    <ul class="dropdown-menu" role="menu">
                          {% for ai in object.agenda_items.all %}
                              <li{% if meeting == ai.meeting %} class="active"{% endif %}>
                                  <a role="menuitem" href="#" data-toggle="filter"
                                      data-show=".filter-meeting-{{ai.meeting.id}}">
                                      {{ai.meeting.get_title_or_shortdate}}
                                  </a>
                              </li>
                          {% endfor %}
                    </ul>
                  </li>

                    <li{% if not meeting and object.is_archived %} class="active"{% endif %}>
                        <a href="#" data-toggle="filter">{% trans "All" %}</a>
                    </li>
                </ul>
            {% endif %}

            {% if object.is_archived or object.is_upcoming %}
                <div class="text-right col-xs-12" style="font-size: 14px;">
                    {% if object.is_archived %}
                        --{% trans "Closed" %}--
                    {% else %}
                        {% if object.is_upcoming %}
                            {% if community.upcoming_meeting_is_published or cperms.communities.viewupcoming_draft %}
                                --{% trans "In agenda" %}--
                            {% endif %}
                        {% endif %}
                    {% endif %}
                </div>
            {% endif %}

            <div class="tab-content">

                <div>
                    <div class="issue-top" style="border-bottom: 1px solid #e2e2e2;">
                        {% include "issues/_issue_title.html" %}
                    </div>

                        <h2 class="filter-title pull-left">{% trans "Background" %}</h2>
                        <div class="abstracts">

                            {% if cperms.issues.editclosed_issue or not object.is_archived %}
                                {% if cperms.issues.editopen_issue or object.created_by == user %}
                                    <div class="filter filter-upcoming pull-right">
                                        <h5>
                                            <a data-rel="form" data-replace="#issue-abstract" href="{% url 'issue_edit_abstract' object.community.id object.id %}" title='{% trans "Edit Abstract" %}' style="color: #6C6C6E;"> <i class="fa fa-edit"></i> {% trans "Edit Abstract" %}</a>
                                            <a id="add-attachment" data-rel="form" href="{% url 'add_attachment' community.id object.id %}" title='{% trans "Add attachment" %}' style="color: #6C6C6E;"> <i class="fa fa-paperclip"></i> {% trans "Add attachment" %}</a>
                                        </h5>
                                    </div>
                                {% endif %}
                            {% endif %}

                            {% for ai in object.agenda_items.all %}
                                {% if ai.background %}
                                    <div class="issue-abstract on filter-meeting-{{ai.meeting.id}} filter" style="clear: both;">
                                        <a href="{{ai.meeting.get_absolute_url}}">{{ai.meeting.get_title_or_date}}:</a>
                                        {{ai.background|userhtml}}
                                    </div>
                                {% endif %}
                            {% endfor %}

                            <div id="issue-abstract" style="clear: both;">
                                {% include 'issues/_issue-abstract.html' %}
                            </div>
                        </div>

                    <h2 class="filter-title">
                        {% trans "Decisions" %}
                    </h2>
                    <div>
                        {% for ai in object.agenda_items.all %}
                            {% if ai.proposals.count %}
                                <div class="filter-meeting-{{ai.meeting.id}} filter">
                                    {% for proposal in ai.proposals|dictsortreversed:"created_at" %}
                                        {% include 'issues/_proposal.html' %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        {% endfor %}
                    </div>

                    <h2 class="filter-title">
                        {% trans "Proposals" %}
                    </h2>
                    <div>
                        <div class="open-proposals filter-upcoming filter">
                            {% for proposal in object.proposals.open %}
                                {% include 'issues/_proposal.html' %}
                                {% if can_straw_vote and not proposal.decided and cperms.issues.vote and user|member_of:community %}
                                    <div class="issue_proposal_vote">
                                        {% include 'issues/_vote.html' %}
                                    </div>
                                {% endif %}
                            {% endfor %}
                        </div>

                        {% if cperms.issues.add_proposal and not object.is_archived %}
                            <div class="narrow clear filter filter-upcoming">
                                <a class="btn btn-oc btn-lg btn-block" data-rel="form" data-append-to=".open-proposals" href="{% url "proposal_create" community.id object.id %}">{% trans "Add Proposal" %}</a>
                            </div>
                        {% endif %}
                    </div>

                    <h2 class="filter-title">
                        {% trans "Summary" %}
                    </h2>
                    {% if object.active_comments.count or cperms.issues.add_issuecomment and object.community.upcoming_meeting_started and object.is_upcoming %}
                    <div class="issuecomments">
                        <ul id="comments" class="comments">
                            {% for ai in object.agenda_items.all %}
                                {% if ai.comments.count %}
                                    {% for c in ai.comments %}
                                        {% include "issues/_comment.html" %}
                                    {% endfor %}
                                {% endif %}
                            {% endfor %}
                            {% for c in object.new_comments %}
                                {% include "issues/_comment.html" %}
                            {% endfor %}
                            {% if cperms.issues.add_issuecomment and object.community.upcoming_meeting_started and object.is_upcoming %}
                                <li class="rich_editor filter-upcoming filter">
                                    <form id="add-comment" method="post">
                                        {% csrf_token %}
                                        {{form}}
                                        <div class="col-xs-12 text-center rich_editor_box">
                                            <button class="add-comment-btn btn btn-oc btn-lg" disabled="1" style="width: 200px;">
                                                {% trans "Save" %}
                                            </button>
                                        </div>
                                    </form>
                                </li>
                            {% endif %}
                        </ul>
                    </div>
                    {% endif %}
                </div>

            </div>
            {% endwith %}
        </div>
    </div>
</div>

{% endblock %}

{% block extrahead %}
    <link rel="stylesheet" href="{{STATIC_URL}}css/issue.css"/>
    <link rel="stylesheet" href="{{STATIC_URL}}bootstrap/css/typeahead.js-bootstrap.css"/>
{% endblock %}

{% block scripts %}
    <script src="{{STATIC_URL}}js/issue.js"></script>
    <script src="{{STATIC_URL}}js/Chart.js"></script>
    <script src="{{STATIC_URL}}js/proposal.js"></script>
    <script src="{{STATIC_URL}}js/_piechart.js"></script>
    <script src="{{STATIC_URL}}bootstrap/js/typeahead.min.js"></script>
    <script src="{{ STATIC_URL }}js/hogan-2.0.0.js"></script>
    <script src="{{STATIC_URL}}js/issues.js"></script>
    <script src="{{STATIC_URL}}js/filter.js"></script>
    <script src="{% url 'jsi18n' %}"></script>

    <script>
        $(function() {
            {% for proposal in object.proposals.open %}
                {% if proposal.can_show_straw_votes %}
                    createChart(
                        {{ proposal.votes_pro|default_if_none:0 }},
                        {{ proposal.votes_con|default_if_none:0 }},
                        {{ proposal.community_members|subtract:proposal.votes_con|default_if_none:0|subtract:proposal.votes_pro|default_if_none:0 }},
                        {{ proposal.id }}
                    );
                {% endif %}
            {% endfor %}

            {% if object.agenda_items.count %}
                $('.active > [data-toggle=filter]').click();
            {% endif %}
        });
    </script>

{% endblock %}
